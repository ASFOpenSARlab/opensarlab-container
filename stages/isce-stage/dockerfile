FROM base-stage: as isce-stage

ENV ISCE_HOME /opt/isce2/isce/
ENV PYTHONPATH $PYTHONPATH:/opt/isce2
ENV PATH $PATH:$ISCE_HOME/bin:$ISCE_HOME/applications

RUN apt install --no-install-recommends -y \
    libfftw3-dev \
    libxm4

RUN conda install gdal==3.1.3 libgcc

RUN pip install 'numpy==1.19.1' 'h5py==2.10.0' 'scipy==1.5.2'

COPY --from=isce-native: /opt/isce2/isce $ISCE_HOME

# Add extra files to ISCE
COPY topo.py $ISCE_HOME/applications/
COPY unpackFrame_ALOS_raw.py $ISCE_HOME/applications/
RUN chmod 755 $ISCE_HOME/applications/*

# So that users can temporarily add items to ISCE
RUN chown -R jovyan:root $ISCE_HOME

# Clean up a few other things at the end
RUN apt update && \
    rm -rf /var/lib/apt/lists/* && \
    apt autoremove -y && \
    conda clean --yes --all


FROM isce-stage as isce-stage-test

COPY tests/isce.sh isce.sh
RUN bash isce.sh
